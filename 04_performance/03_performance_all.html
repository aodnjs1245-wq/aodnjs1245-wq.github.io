<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>서환산업 | 전체 사업실적</title>
  <!-- 공통 -->
  <link rel="stylesheet" href="/css/01_common.css">
  <!-- 페이지별 -->
  <link rel="stylesheet" href="/css/02_pages.css">
</head>

<body>

  <!-- ===== 공통 헤더 삽입 영역 ===== -->
  <div id="app-header"></div>

  <main class="subpage">

    <!-- ===== 사업실적 상단 비주얼 ===== -->
    <section class="sub-visual sub-visual--company">
      <div class="sub-visual-inner">
        <h1 class="sub-visual-title">전체 사업실적</h1>
        <p class="sub-visual-desc">
          서환산업의 전체 사업실적입니다.
        </p>

        <nav class="breadcrumb" aria-label="현재 위치">

          <a href="/01_home/01_index.html" class="breadcrumb-link">홈</a>
          <span class="breadcrumb-sep">/</span>

          <!-- 사업실적 드롭다운 -->
          <div class="breadcrumb-dropdown">
            <a class="breadcrumb-link breadcrumb-toggle" href="/04_performance/04_portfolio.html">
              사업실적
            </a>

            <ul class="breadcrumb-menu">
              <li><a href="/04_performance/01_performance_key.html">주요 실적</a></li>
              <li><a href="/04_performance/05_performance_delivery.html">제작·납품 실적</a></li>
              <li><a href="/04_performance/02_performance_maintenance.html">운영 및 경상정비 실적</a></li>
              <li><a href="/04_performance/03_performance_all.html">전체 사업실적</a></li>
            </ul>
          </div>

          <span class="breadcrumb-sep">/</span>
          <span class="breadcrumb-current">전체 사업실적</span>

        </nav>
    </section>

    <!-- ===== 전체 사업실적 표 ===== -->
    <section class="perf-table-section">
      <div class="table-wrap">
        <table class="perf-table perf-table-all">
          <thead>
            <tr>
              <th>공사일자</th>
              <th>공사명</th>
              <th>발주처</th>
            </tr>
          </thead>

          <tbody id="allPerfTbody"></tbody>
        </table>
      </div>

      <!-- ===== 페이지네이션 ===== -->
      <nav class="pagination" aria-label="페이지 이동" id="allPerfPagination"></nav>
    </section>

  </main>

  <!-- ===== 공통 푸터 삽입 영역 ===== -->
  <div id="app-footer"></div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Supabase Client (이미 있는 파일) -->
  <script src="/js/01_supabase.js"></script>

  <!-- 공통 JS -->
  <script src="/js/00_common.js"></script>

  <!-- 전체 사업실적 로드(반드시 supabase 로드 이후) -->
  <script>
    /* =========================
       전체 사업실적(3열) - Supabase 연동 + 25개 페이지네이션
       - supabaseClient 준비 후 실행
    ========================= */

    const tbody = document.getElementById("allPerfTbody");
    const pagination = document.getElementById("allPerfPagination");

    const PER_PAGE = 25;
    let currentPage = 1;
    let ALL_PERFORMANCE = [];

    function toSortKey(workDate) {
      const m = String(workDate || "").match(/^(\d{4})\.(\d{1,2})/);
      if (!m) return 0;
      const y = Number(m[1]);
      const mo = Number(m[2]);
      return y * 100 + mo;
    }

    async function waitForSupabaseClient(timeoutMs = 3000) {
      const start = Date.now();
      while (!window.supabaseClient) {
        if (Date.now() - start > timeoutMs) return false;
        await new Promise(r => setTimeout(r, 50));
      }
      return true;
    }

    async function loadPerformance() {
      try {
        const ready = await waitForSupabaseClient();
        if (!ready) throw new Error("Supabase Client가 없습니다. /js/01_supabase.js 로드 순서를 확인하세요.");

        const sb = window.supabaseClient;

        const { data, error } = await sb
          .from("performance_all")
          .select("work_date, work_title, client, sort_key, created_at")
          .order("sort_key", { ascending: false })
          .order("created_at", { ascending: false });

        if (error) throw error;

        ALL_PERFORMANCE = (data || []).map((row) => ({
          date: row.work_date,
          title: row.work_title,
          client: row.client,
          sort_key: row.sort_key ?? toSortKey(row.work_date),
          created_at: row.created_at
        }));

        currentPage = 1;
        renderTable(currentPage);
        renderPagination(currentPage);

      } catch (err) {
        console.error(err);
        tbody.innerHTML = `
        <tr>
          <td colspan="3">데이터를 불러오지 못했습니다. (콘솔을 확인해주세요)</td>
        </tr>
      `;
        pagination.innerHTML = "";
      }
    }

    function renderTable(page) {
      const total = ALL_PERFORMANCE.length;
      const start = (page - 1) * PER_PAGE;
      const end = Math.min(start + PER_PAGE, total);

      tbody.innerHTML = ALL_PERFORMANCE.slice(start, end).map((item) => `
      <tr>
        <td>${item.date || ""}</td>
        <td>${item.title || ""}</td>
        <td>${item.client || ""}</td>
      </tr>
    `).join("");
    }

    function renderPagination(page) {
      const totalPages = Math.ceil(ALL_PERFORMANCE.length / PER_PAGE);

      if (totalPages <= 1) {
        pagination.innerHTML = "";
        return;
      }

      const windowSize = 7;
      let start = Math.max(1, page - Math.floor(windowSize / 2));
      let end = Math.min(totalPages, start + windowSize - 1);
      start = Math.max(1, end - windowSize + 1);

      const prevDisabled = page === 1 ? "disabled" : "";
      const nextDisabled = page === totalPages ? "disabled" : "";

      let html = "";
      html += `<a href="#" class="${prevDisabled}" data-page="${page - 1}">이전</a>`;

      for (let p = start; p <= end; p++) {
        const active = p === page ? "active" : "";
        html += `<a href="#" class="${active}" data-page="${p}">${p}</a>`;
      }

      html += `<a href="#" class="${nextDisabled}" data-page="${page + 1}">다음</a>`;
      pagination.innerHTML = html;
    }

    pagination.addEventListener("click", (e) => {
      const a = e.target.closest("a");
      if (!a) return;
      e.preventDefault();

      if (a.classList.contains("disabled")) return;

      const totalPages = Math.ceil(ALL_PERFORMANCE.length / PER_PAGE);
      const page = Number(a.dataset.page);

      if (page < 1 || page > totalPages) return;

      currentPage = page;
      renderTable(currentPage);
      renderPagination(currentPage);

      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    document.addEventListener("DOMContentLoaded", loadPerformance);
  </script>
</body>

</html>